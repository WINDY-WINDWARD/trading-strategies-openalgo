<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supertrend Trading Bot Dashboard</title>
    
    <!-- Plotly.js -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Socket.IO -->
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
    
    <style>
        body {
            background-color: #1a1a1a;
            color: #ffffff;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .dashboard-card {
            background: linear-gradient(135deg, #2d3436, #636e72);
            border: 1px solid #404040;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            margin-bottom: 20px;
        }
        
        .metric-card {
            background: linear-gradient(135deg, #00b894, #00a085);
            color: white;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            margin-bottom: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        .metric-card.negative {
            background: linear-gradient(135deg, #e17055, #d63031);
        }
        
        .metric-card.neutral {
            background: linear-gradient(135deg, #636e72, #2d3436);
        }
        
        .metric-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .metric-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        .chart-container {
            position: relative;
            height: 500px;
            background: #2d3436;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .orders-table {
            background: #2d3436;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .table-dark {
            --bs-table-bg: #2d3436;
            --bs-table-border-color: #404040;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-active {
            background-color: #00b894;
            animation: pulse 2s infinite;
        }
        
        .status-inactive {
            background-color: #636e72;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #0984e3, #74b9ff);
            border: none;
            border-radius: 8px;
            padding: 10px 20px;
            font-weight: 600;
        }
        
        .btn-success {
            background: linear-gradient(135deg, #00b894, #55efc4);
            border: none;
            border-radius: 8px;
            padding: 10px 20px;
            font-weight: 600;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #e17055, #fab1a0);
            border: none;
            border-radius: 8px;
            padding: 10px 20px;
            font-weight: 600;
        }
        
        .navbar-brand {
            font-size: 1.5rem;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark" style="background: linear-gradient(135deg, #2d3436, #636e72);">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                ðŸ“ˆ Supertrend Trading Dashboard
            </a>
            <div class="navbar-nav ms-auto">
                <span class="nav-item">
                    <span class="status-indicator" id="connectionStatus"></span>
                    <span id="connectionText">Connecting...</span>
                </span>
            </div>
        </div>
    </nav>

    <div class="container-fluid py-4">
        <!-- Summary Metrics Row -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="metric-card" id="pnlCard">
                    <div class="metric-value" id="totalPnl">â‚¹0.00</div>
                    <div class="metric-label">Total P&L</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card neutral">
                    <div class="metric-value" id="currentPrice">â‚¹0.00</div>
                    <div class="metric-label">Current Price</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card neutral">
                    <div class="metric-value" id="position">0</div>
                    <div class="metric-label">Position</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card neutral">
                    <div class="metric-value" id="totalTrades">0</div>
                    <div class="metric-label">Total Trades</div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Price Chart -->
            <div class="col-lg-8">
                <div class="dashboard-card">
                    <div class="card-body">
                        <h5 class="card-title mb-3">ðŸ“Š OHLC Chart & Supertrend</h5>
                        <div class="chart-container" id="ohlcChart"></div>
                    </div>
                </div>
            </div>

            <!-- Right Sidebar -->
            <div class="col-lg-4">
                <!-- Trading Controls -->
                <div class="dashboard-card">
                    <div class="card-body">
                        <h5 class="card-title mb-3">ðŸš€ Trading Controls</h5>
                        <div class="d-grid gap-2">
                            <button class="btn btn-success" id="startTrading">Start Trading</button>
                            <button class="btn btn-danger" id="stopTrading">Stop Trading</button>
                            <div class="mt-2">
                                <small class="text-muted">Status: <span id="tradingStatus" class="badge bg-secondary">Stopped</span></small>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Monitoring Controls -->
                <div class="dashboard-card">
                    <div class="card-body">
                        <h5 class="card-title mb-3">ðŸŽ® Monitoring</h5>
                        <div class="d-grid gap-2">
                            <button class="btn btn-success" id="startMonitoring">Start Monitoring</button>
                            <button class="btn btn-danger" id="stopMonitoring">Stop Monitoring</button>
                            <button class="btn btn-primary" id="refreshData">Refresh Data</button>
                        </div>
                    </div>
                </div>

                <!-- Bot Status -->
                <div class="dashboard-card">
                    <div class="card-body">
                        <h5 class="card-title mb-3">ðŸ¤– Bot Status</h5>
                        <div id="botStatus">
                            <p><strong>Symbol:</strong> <span id="symbol">-</span></p>
                            <p><strong>Status:</strong> <span id="botActive">-</span></p>
                        </div>
                    </div>
                </div>

                <!-- Chart Controls -->
                <div class="dashboard-card">
                    <div class="card-body">
                        <h5 class="card-title mb-3">ðŸ“Š Chart Settings</h5>
                        <div class="mb-3">
                            <label for="dataPoints" class="form-label">Data Points</label>
                            <select class="form-select form-select-sm" id="dataPoints" style="background-color: #2d3436; color: white; border: 1px solid #404040;">
                                <option value="50">Last 50 points</option>
                                <option value="100">Last 100 points</option>
                                <option value="200" selected>Last 200 points</option>
                                <option value="500">Last 500 points</option>
                                <option value="all">All data</option>
                            </select>
                        </div>
                        <button class="btn btn-primary btn-sm w-100" id="updateChart">Update Chart</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Orders Table -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="dashboard-card">
                    <div class="card-body">
                        <h5 class="card-title mb-3">ðŸ“‹ Recent Orders</h5>
                        <div class="orders-table">
                            <table class="table table-dark table-striped">
                                <thead>
                                    <tr>
                                        <th>Time</th>
                                        <th>Type</th>
                                        <th>Quantity</th>
                                        <th>Price</th>
                                        <th>Status</th>
                                        <th>Order ID</th>
                                    </tr>
                                </thead>
                                <tbody id="ordersTableBody">
                                    <tr>
                                        <td colspan="6" class="text-center text-muted">Loading orders...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Initialize Socket.IO connection
        const socket = io('http://localhost:5002');
        
        // Global variable to store current OHLC data
        let currentOhlcData = null;
        
        // Socket.IO event handlers
        socket.on('connect', function() {
            setConnectionStatus(true);
            console.log('Connected to server');
        });

        socket.on('disconnect', function() {
            setConnectionStatus(false);
            console.log('Disconnected from server');
        });

        socket.on('price_update', function(data) {
            if (data && data.price) {
                updateCurrentPrice(data.price);
            }
        });

        socket.on('summary_update', function(data) {
            if (data && typeof data === 'object' && !data.error) {
                updateSummaryMetrics(data);
            }
        });

        socket.on('trading_status', function(data) {
            updateTradingStatus(data);
        });
        
        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            loadInitialData();
            setupEventListeners();
            setConnectionStatus(false);
        });

        function setConnectionStatus(connected) {
            const statusElement = document.getElementById('connectionStatus');
            const textElement = document.getElementById('connectionText');
            
            if (connected) {
                statusElement.className = 'status-indicator status-active';
                textElement.textContent = 'Connected';
            } else {
                statusElement.className = 'status-indicator status-inactive';
                textElement.textContent = 'Disconnected';
            }
        }

        function loadInitialData() {
            loadSummary();
            loadOhlcData();
            loadOrders();
        }

        function setupEventListeners() {
            // Trading controls
            document.getElementById('startTrading').addEventListener('click', startTrading);
            document.getElementById('stopTrading').addEventListener('click', stopTrading);
            
            // Monitoring controls
            document.getElementById('startMonitoring').addEventListener('click', startMonitoring);
            document.getElementById('stopMonitoring').addEventListener('click', stopMonitoring);
            document.getElementById('refreshData').addEventListener('click', function() {
                console.log('Manual refresh triggered');
                loadInitialData();
            });
            
            // Chart controls
            document.getElementById('updateChart').addEventListener('click', function() {
                if (currentOhlcData) {
                    updateOhlcChart(currentOhlcData);
                }
            });
        }

        function loadSummary() {
            fetch('/api/summary')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('Error loading summary:', data.error);
                        return;
                    }
                    updateSummaryMetrics(data);
                })
                .catch(error => console.error('Error:', error));
        }

        function loadOhlcData() {
            fetch('/api/ohlc-data')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('Error loading OHLC data:', data.error);
                        return;
                    }
                    currentOhlcData = data; // Store data globally
                    updateOhlcChart(data);
                })
                .catch(error => console.error('Error:', error));
        }

        function loadOrders() {
            fetch('/api/orders')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('Error loading orders:', data.error);
                        return;
                    }
                    updateOrdersTable(data);
                })
                .catch(error => console.error('Error:', error));
        }

        function updateSummaryMetrics(data) {
            document.getElementById('totalPnl').textContent = 'â‚¹' + (data.total_pnl || 0).toFixed(2);
            document.getElementById('currentPrice').textContent = 'â‚¹' + (data.current_price || 0).toFixed(2);
            document.getElementById('position').textContent = data.position || 0;
            document.getElementById('totalTrades').textContent = data.num_trades || 0;

            // Update P&L card color
            const pnlCard = document.getElementById('pnlCard');
            const totalPnl = data.total_pnl || 0;
            if (totalPnl > 0) {
                pnlCard.className = 'metric-card';
            } else if (totalPnl < 0) {
                pnlCard.className = 'metric-card negative';
            } else {
                pnlCard.className = 'metric-card neutral';
            }

            // Update bot status
            document.getElementById('symbol').textContent = data.symbol || '-';
            document.getElementById('botActive').textContent = data.is_active ? 'Active' : 'Inactive';
        }

        function updateCurrentPrice(price) {
            document.getElementById('currentPrice').textContent = 'â‚¹' + price.toFixed(2);
        }

        function updateOhlcChart(data) {
            console.log('Updating OHLC chart with data:', data);
            
            if (!data || !data.data || data.data.length === 0) {
                console.error('No valid data received for chart');
                return;
            }


            // Get selected data points limit
            const dataPointsSelect = document.getElementById('dataPoints');
            const maxPointsValue = dataPointsSelect.value;

            // Filter out data points where any OHLC value is missing or null/undefined/NaN
            let filteredData = data.data.filter(d =>
                d &&
                d.timestamp &&
                d.open != null && !isNaN(d.open) &&
                d.high != null && !isNaN(d.high) &&
                d.low != null && !isNaN(d.low) &&
                d.close != null && !isNaN(d.close)
            );

            let limitedData;
            if (maxPointsValue === 'all') {
                limitedData = filteredData;
            } else {
                const maxPoints = parseInt(maxPointsValue);
                limitedData = filteredData.length > maxPoints ?
                    filteredData.slice(-maxPoints) : filteredData;
            }

            // Prepare categorical x-axis using only timestamps that actually have OHLC data
            const pad = (n) => String(n).padStart(2, '0');
            const formatTime = (ts) => {
                const d = new Date(ts);
                return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
            };

            const ohlcTimeSet = new Set(filteredData.map(d => d.timestamp));
            const categoryX = limitedData.map(d => formatTime(d.timestamp));

            // Filter out data points with zero values (NaN replacements) for overlays
            const validSupertrendData = limitedData.filter(d => d.supertrend !== 0 && ohlcTimeSet.has(d.timestamp));
            const validUpperBandData = limitedData.filter(d => d.upper_band !== 0 && ohlcTimeSet.has(d.timestamp));
            const validLowerBandData = limitedData.filter(d => d.lower_band !== 0 && ohlcTimeSet.has(d.timestamp));

            const trace = {
                x: categoryX,
                open: limitedData.map(d => d.open),
                high: limitedData.map(d => d.high),
                low: limitedData.map(d => d.low),
                close: limitedData.map(d => d.close),
                type: 'candlestick',
                name: 'OHLC',
                increasing: {line: {color: '#00b894', width: 1}},
                decreasing: {line: {color: '#e17055', width: 1}},
                line: {width: 1}
            };

            const supertrendTrace = {
                x: validSupertrendData.map(d => formatTime(d.timestamp)),
                y: validSupertrendData.map(d => d.supertrend),
                type: 'scatter',
                mode: 'lines',
                name: 'Supertrend',
                line: {
                    color: '#74b9ff',
                    width: 2
                },
                connectgaps: false
            };

            const upperBandTrace = {
                x: validUpperBandData.map(d => formatTime(d.timestamp)),
                y: validUpperBandData.map(d => d.upper_band),
                type: 'scatter',
                mode: 'lines',
                name: 'Upper Band',
                line: {
                    color: '#fd79a8',
                    width: 1,
                    dash: 'dot'
                },
                opacity: 0.6,
                connectgaps: false
            };

            const lowerBandTrace = {
                x: validLowerBandData.map(d => formatTime(d.timestamp)),
                y: validLowerBandData.map(d => d.lower_band),
                type: 'scatter',
                mode: 'lines',
                name: 'Lower Band',
                line: {
                    color: '#a29bfe',
                    width: 1,
                    dash: 'dot'
                },
                opacity: 0.6,
                connectgaps: false
            };

            const layout = {
                title: {
                    text: `OHLC Chart with Supertrend & Bands (${limitedData.length} points)`,
                    font: { color: '#ffffff', size: 16 }
                },
                xaxis: { 
                    title: 'Date',
                    gridcolor: '#404040',
                    color: '#ffffff',
                    rangeslider: {visible: false}, // Remove range slider for cleaner look
                    type: 'category',
                    categoryorder: 'array',
                    categoryarray: categoryX,
                    tickmode: 'auto',
                    nticks: 10
                },
                yaxis: { 
                    title: 'Price (â‚¹)',
                    gridcolor: '#404040',
                    color: '#ffffff',
                    fixedrange: false,
                    autorange: true
                },
                plot_bgcolor: '#2d3436',
                paper_bgcolor: '#2d3436',
                font: { color: '#ffffff', size: 12 },
                showlegend: true,
                legend: {
                    font: { color: '#ffffff', size: 11 },
                    x: 0.02,
                    y: 0.98,
                    bgcolor: 'rgba(45, 52, 54, 0.8)',
                    bordercolor: '#404040',
                    borderwidth: 1
                },
                margin: {
                    l: 60,
                    r: 20,
                    t: 60,
                    b: 60
                },
                hovermode: 'x unified'
            };

            const config = {
                responsive: true,
                displayModeBar: true,
                modeBarButtonsToRemove: ['pan2d', 'lasso2d', 'select2d'],
                displaylogo: false,
                scrollZoom: true,
                doubleClick: 'reset+autosize'
            };

            Plotly.newPlot('ohlcChart', [trace, supertrendTrace, upperBandTrace, lowerBandTrace], layout, config);
        }

        function updateOrdersTable(orderData) {
            const tbody = document.getElementById('ordersTableBody');
            tbody.innerHTML = '';

            if (orderData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No orders found</td></tr>';
                return;
            }

            orderData.forEach(order => {
                const row = document.createElement('tr');
                const timestamp = new Date(order.timestamp).toLocaleString();
                const price = order.price || 0;
                const statusClass = order.status === 'FILLED' ? 'success' : 'warning';
                
                row.innerHTML = `
                    <td>${timestamp}</td>
                    <td><span class="badge bg-${order.action === 'buy' ? 'success' : 'danger'}">${order.action}</span></td>
                    <td>${order.quantity}</td>
                    <td>â‚¹${price.toFixed(2)}</td>
                    <td><span class="badge bg-${statusClass}">${order.status}</span></td>
                    <td class="text-muted">${order.order_id}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function startMonitoring() {
            fetch('/api/start-monitoring', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    console.log('Monitoring started:', data);
                    document.getElementById('startMonitoring').disabled = true;
                    document.getElementById('stopMonitoring').disabled = false;
                })
                .catch(error => console.error('Error:', error));
        }

        function stopMonitoring() {
            fetch('/api/stop-monitoring', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    console.log('Monitoring stopped:', data);
                    document.getElementById('startMonitoring').disabled = false;
                    document.getElementById('stopMonitoring').disabled = true;
                })
                .catch(error => console.error('Error:', error));
        }

        function startTrading() {
            if (!confirm('This will start live trading with real money. Are you sure?')) {
                return;
            }
            
            fetch('/api/start-trading', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert('Error starting trading: ' + data.error);
                    } else {
                        console.log('Trading started:', data);
                        alert('Supertrend trading started!');
                        updateTradingStatus({ trading_active: true });
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error starting trading');
                });
        }

        function stopTrading() {
            if (!confirm('This will stop supertrend trading. Continue?')) {
                return;
            }
            
            fetch('/api/stop-trading', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    console.log('Trading stopped:', data);
                    alert('Supertrend trading stopped!');
                    updateTradingStatus({ trading_active: false });
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error stopping trading');
                });
        }

        function updateTradingStatus(data) {
            const statusElement = document.getElementById('tradingStatus');
            if (data.trading_active) {
                statusElement.textContent = 'Trading Active';
                statusElement.className = 'badge bg-success';
                document.getElementById('startTrading').disabled = true;
                document.getElementById('stopTrading').disabled = false;
            } else {
                statusElement.textContent = 'Stopped';
                statusElement.className = 'badge bg-secondary';
                document.getElementById('startTrading').disabled = false;
                document.getElementById('stopTrading').disabled = true;
            }
        }
    </script>
</body>
</html>
