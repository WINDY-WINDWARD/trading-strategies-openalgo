<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grid Trading Backtester</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js" charset="utf-8"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }
        .chart-container {
            height: 600px;
            min-height: 500px;
            width: 100%;
        }
        @media (min-height: 800px) {
            .chart-container {
                height: 70vh;
                min-height: 600px;
            }
        }
        @media (min-height: 1000px) {
            .chart-container {
                height: 65vh;
                min-height: 650px;
            }
        }
        .metric-card {
            background-color: var(--bs-tertiary-bg);
            border-radius: .5rem;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        .metric-value {
            font-size: 1.75rem;
            font-weight: 500;
        }
        .metric-label {
            font-size: 0.9rem;
            color: var(--bs-secondary-color);
        }
        .table-responsive {
            max-height: 400px;
        }
        #status-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: var(--bs-body-bg);
            border-top: 1px solid var(--bs-border-color);
            padding: 0.5rem 1rem;
            z-index: 1000;
        }
        .nav-tabs .nav-link {
            color: var(--bs-secondary-color);
        }
        .nav-tabs .nav-link.active {
            color: var(--bs-primary);
        }
        .card-header-tabs {
            margin-bottom: -1px;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg bg-body-tertiary border-bottom">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">ðŸ“ˆ Grid Trading Backtester</a>
            <div id="ws-status" class="text-secondary">
                <span class="spinner-grow spinner-grow-sm text-secondary" role="status"></span>
                Connecting...
            </div>
        </div>
    </nav>

    <main class="container-fluid mt-4">
        <div class="row">
            <!-- Controls and Config -->
            <div class="col-lg-3">
                <h4>Controls</h4>
                <div class="card mb-4">
                    <div class="card-body">
                        <button id="run-backtest-btn" class="btn btn-primary w-100">Run Backtest</button>
                        <div id="progress-container" class="mt-3" style="display: none;">
                            <div class="progress" role="progressbar">
                                <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" style="width: 0%"></div>
                            </div>
                            <small id="progress-text" class="form-text text-muted"></small>
                        </div>
                    </div>
                </div>

                <h4>Configuration</h4>
                <div class="card">
                    <div class="card-body">
                        <textarea id="config-editor" class="form-control" rows="20" style="font-family: monospace; font-size: 0.8rem;"></textarea>
                        <button id="save-config-btn" class="btn btn-secondary w-100 mt-2">Save Config</button>
                    </div>
                </div>
            </div>

            <!-- Results -->
            <div class="col-lg-9">
                <div id="results-container" style="display: none;">
                    <h4>Backtest Results (<span id="run-id-display"></span>)</h4>
                    <!-- Metrics -->
                    <div class="row">
                        <div class="col-md-4"><div class="metric-card"><div id="metric-final-value" class="metric-value"></div><div class="metric-label">Final Portfolio Value</div></div></div>
                        <div class="col-md-4"><div class="metric-card"><div id="metric-return" class="metric-value"></div><div class="metric-label">Total Return %</div></div></div>
                        <div class="col-md-4"><div class="metric-card"><div id="metric-max-drawdown" class="metric-value"></div><div class="metric-label">Max Drawdown %</div></div></div>
                        <div class="col-md-4"><div class="metric-card"><div id="metric-sharpe" class="metric-value"></div><div class="metric-label">Sharpe Ratio</div></div></div>
                        <div class="col-md-4"><div class="metric-card"><div id="metric-trades" class="metric-value"></div><div class="metric-label">Total Trades</div></div></div>
                        <div class="col-md-4"><div class="metric-card"><div id="metric-win-rate" class="metric-value"></div><div class="metric-label">Win Rate %</div></div></div>
                        <div class="col-md-4"><div class="metric-card"><div id="metric-profit-factor" class="metric-value"></div><div class="metric-label">Profit Factor</div></div></div>
                    </div>

                    <!-- Charts -->
                    <div class="row">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <ul class="nav nav-tabs card-header-tabs" id="chart-tabs" role="tablist">
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link active" id="equity-tab" data-bs-toggle="tab" data-bs-target="#equity-pane" type="button" role="tab">Equity Curve</button>
                                        </li>
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link" id="candle-tab" data-bs-toggle="tab" data-bs-target="#candle-pane" type="button" role="tab">Candlestick Chart</button>
                                        </li>
                                    </ul>
                                </div>
                                <div class="card-body">
                                    <div class="tab-content" id="chart-tab-content">
                                        <div class="tab-pane fade show active" id="equity-pane" role="tabpanel">
                                            <div id="equity-chart" class="chart-container"></div>
                                        </div>
                                        <div class="tab-pane fade" id="candle-pane" role="tabpanel">
                                            <div id="candle-chart" class="chart-container"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Trades Table -->
                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">Order Executions</div>
                                <div class="card-body">
                                        <button id="export-csv-btn" class="btn btn-outline-success mb-3">Export Trades to CSV</button>
                                    <div class="table-responsive">
                                        <table class="table table-sm">
                                            <thead>
                                                <tr>
                                                    <th>Execution Time</th>
                                                    <th>Order Time</th>
                                                    <th>Side</th>
                                                    <th>Quantity</th>
                                                    <th>Requested</th>
                                                    <th>Executed</th>
                                                    <th>Fees</th>
                                                </tr>
                                            </thead>
                                            <tbody id="trades-table"></tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="welcome-message" class="text-center p-5">
                    <h3>Welcome to the Grid Trading Backtester</h3>
                    <p class="text-muted">Click "Run Backtest" to start a simulation.</p>
                </div>
            </div>
        </div>
    </main>

    <div id="status-bar">
        <span id="status-text">Ready.</span>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

        <script>
        document.addEventListener('DOMContentLoaded', function() {
            const exportBtn = document.getElementById('export-csv-btn');
            if (exportBtn) {
                exportBtn.addEventListener('click', function() {
                    window.open('/api/export-trades-csv', '_blank');
                });
            }
        });
        </script>
    <script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const wsStatus = document.getElementById('ws-status');
            const runBtn = document.getElementById('run-backtest-btn');
            const saveBtn = document.getElementById('save-config-btn');
            const configEditor = document.getElementById('config-editor');
            const statusBar = document.getElementById('status-text');
            const progressContainer = document.getElementById('progress-container');
            const progressBar = document.getElementById('progress-bar');
            const progressText = document.getElementById('progress-text');
            const resultsContainer = document.getElementById('results-container');
            const welcomeMessage = document.getElementById('welcome-message');

            let currentRunId = null;

            // --- WebSocket ---
            function setupWebSocket() {
                const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsUrl = `${wsProtocol}//${window.location.host}/ws`;
                const ws = new WebSocket(wsUrl);

                ws.onopen = () => {
                    wsStatus.innerHTML = '<span class="badge bg-success">Connected</span>';
                };

                ws.onmessage = (event) => {
                    const msg = JSON.parse(event.data);

                    if (msg.run_id && msg.run_id !== currentRunId) return;

                    switch (msg.type) {
                        case 'status':
                            updateStatus(msg.message);
                            break;
                        case 'progress':
                            updateProgress(msg.data);
                            break;
                        case 'result':
                            updateStatus('Backtest completed.');
                            displayResults(msg.data);
                            runBtn.disabled = false;
                            progressContainer.style.display = 'none';
                            break;
                        case 'error':
                            updateStatus(`Error: ${msg.message}`);
                            alert(`Backtest Error: ${msg.message}`);
                            runBtn.disabled = false;
                            progressContainer.style.display = 'none';
                            break;
                    }
                };

                ws.onclose = () => {
                    wsStatus.innerHTML = '<span class="badge bg-danger">Disconnected</span>';
                    // Try to reconnect after 3 seconds
                    setTimeout(setupWebSocket, 3000);
                };

                ws.onerror = () => {
                    wsStatus.innerHTML = '<span class="badge bg-danger">Error</span>';
                };
            }

            // --- UI Updates ---
            function updateStatus(message) {
                statusBar.textContent = message;
            }

            function updateProgress(data) {
                const progressPct = data.progress_pct || 0;
                progressBar.style.width = `${progressPct}%`;
                progressBar.textContent = `${Math.round(progressPct)}%`;
                progressText.textContent = `Processing: ${new Date(data.current_time).toLocaleString()}`;
            }

            function displayResults(result) {
                welcomeMessage.style.display = 'none';
                resultsContainer.style.display = 'block';

                document.getElementById('run-id-display').textContent = result.run_id;

                // Metrics
                const metrics = result.metrics;
                
                // Calculate final portfolio value from equity curve
                const finalEquity = result.equity_curve && result.equity_curve.length > 0 
                    ? result.equity_curve[result.equity_curve.length - 1].equity 
                    : 0;
                
                document.getElementById('metric-final-value').textContent = `$${finalEquity.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
                document.getElementById('metric-return').textContent = metrics.total_return_pct.toFixed(2);
                document.getElementById('metric-max-drawdown').textContent = metrics.max_drawdown_pct.toFixed(2);
                document.getElementById('metric-sharpe').textContent = metrics.sharpe_ratio ? metrics.sharpe_ratio.toFixed(3) : 'N/A';
                document.getElementById('metric-trades').textContent = metrics.total_trades;
                document.getElementById('metric-win-rate').textContent = metrics.win_rate.toFixed(1);
                document.getElementById('metric-profit-factor').textContent = metrics.profit_factor ? metrics.profit_factor.toFixed(2) : 'N/A';

                // Equity Chart
                const equityCurve = result.equity_curve;
                const equityTrace = {
                    x: equityCurve.map(p => p.timestamp),
                    y: equityCurve.map(p => p.equity),
                    type: 'scatter',
                    mode: 'lines',
                    name: 'Equity',
                    line: { color: '#00ff88' }
                };
                const equityLayout = {
                    margin: { l: 60, r: 30, t: 30, b: 50 },
                    paper_bgcolor: 'rgba(0,0,0,0)',
                    plot_bgcolor: 'rgba(0,0,0,0)',
                    xaxis: { 
                        gridcolor: '#444',
                        title: 'Time'
                    },
                    yaxis: { 
                        gridcolor: '#444',
                        title: 'Equity ($)'
                    },
                    font: { color: '#fff' },
                    showlegend: false,
                    autosize: true
                };
                Plotly.newPlot('equity-chart', [equityTrace], equityLayout, {responsive: true, displayModeBar: true});

                // Candlestick Chart
                if (result.candles) {
                    const candles = result.candles;
                    const candlestickTrace = {
                        x: candles.map(c => c.timestamp),
                        open: candles.map(c => c.open),
                        high: candles.map(c => c.high),
                        low: candles.map(c => c.low),
                        close: candles.map(c => c.close),
                        type: 'candlestick',
                        name: result.symbol || 'Price',
                        increasing: { 
                            line: { color: '#00ff88'},
                            fillcolor: '#00ff88'
                        },
                        decreasing: { 
                            line: { color: '#ff4444'},
                            fillcolor: '#ff4444'
                        },
                        whiskerwidth: 0.8,
                        xaxis: 'x',
                        yaxis: 'y'
                    };

                    // Add order execution markers if available
                    const traces = [candlestickTrace];
                    
                    if (result.trades && result.trades.length > 0) {
                        const buyOrders = result.trades.filter(t => t.side === 'BUY');
                        const sellOrders = result.trades.filter(t => t.side === 'SELL');

                        // Buy order executions
                        if (buyOrders.length > 0) {
                            traces.push({
                                x: buyOrders.map(t => t.entry_time),
                                y: buyOrders.map(t => t.entry_price),
                                mode: 'markers',
                                type: 'scatter',
                                name: 'Buy Executions',
                                marker: {
                                    color: '#00ff88',
                                    size: 8,
                                    symbol: 'triangle-up'
                                }
                            });
                        }

                        // Sell order executions
                        if (sellOrders.length > 0) {
                            traces.push({
                                x: sellOrders.map(t => t.entry_time),
                                y: sellOrders.map(t => t.entry_price),
                                mode: 'markers',
                                type: 'scatter',
                                name: 'Sell Executions',
                                marker: {
                                    color: '#ff4444',
                                    size: 8,
                                    symbol: 'triangle-down'
                                }
                            });
                        }
                    }

                    const candleLayout = {
                        margin: { l: 60, r: 30, t: 30, b: 50 },
                        paper_bgcolor: 'rgba(0,0,0,0)',
                        plot_bgcolor: 'rgba(0,0,0,0)',
                        xaxis: { 
                            gridcolor: '#444',
                            title: 'Time',
                            rangeslider: { visible: false },
                            type: 'date',
                            automargin: true,
                            tickangle: -45,
                            nticks: 10
                        },
                        yaxis: { 
                            gridcolor: '#444',
                            title: 'Price ($)',
                            automargin: true
                        },
                        font: { color: '#fff' },
                        showlegend: true,
                        legend: {
                            x: 0,
                            y: 1,
                            bgcolor: 'rgba(0,0,0,0.5)'
                        },
                        autosize: true,
                        bargap: 0.1,
                        bargroupgap: 0.05
                    };
                    
                    Plotly.newPlot('candle-chart', traces, candleLayout, {
                        responsive: true, 
                        displayModeBar: true,
                        modeBarButtonsToRemove: ['lasso2d', 'select2d']
                    });
                }

                // Order Executions Table
                const tradesTable = document.getElementById('trades-table');
                tradesTable.innerHTML = '';
                result.trades.forEach(trade => {
                    const row = tradesTable.insertRow();
                    const sideClass = trade.side === 'BUY' ? 'text-success' : 'text-danger';
                    const sideText = trade.side;  // Show actual BUY/SELL
                    
                    row.innerHTML = `
                        <td>${new Date(trade.entry_time).toLocaleString()}</td>
                        <td>${new Date(trade.entry_time).toLocaleString()}</td>
                        <td><span class="${sideClass} fw-bold">${sideText}</span></td>
                        <td>${trade.quantity}</td>
                        <td>$${trade.entry_price.toFixed(2)}</td>
                        <td>$${trade.entry_price.toFixed(2)}</td>
                        <td><span class="text-info">$${trade.fees.toFixed(2)}</span></td>
                    `;
                });
            }

            // --- API Calls ---
            async function loadConfig() {
                try {
                    const response = await fetch('/api/config');
                    const config = await response.json();
                    configEditor.value = jsyaml.dump(config);
                } catch (e) {
                    console.error("Failed to load config", e);
                    alert("Failed to load configuration.");
                }
            }

            async function saveConfig() {
                try {
                    const config = jsyaml.load(configEditor.value);
                    const response = await fetch('/api/config', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(config)
                    });
                    if (response.ok) {
                        updateStatus('Configuration saved.');
                    } else {
                        const error = await response.json();
                        throw new Error(error.error || 'Unknown error');
                    }
                } catch (e) {
                    console.error("Failed to save config", e);
                    alert(`Failed to save configuration: ${e.message}`);
                }
            }

            async function runBacktest() {
                runBtn.disabled = true;
                updateStatus('Starting backtest...');
                progressContainer.style.display = 'block';
                progressBar.style.width = '0%';
                progressBar.textContent = '';
                progressText.textContent = 'Initiating...';
                welcomeMessage.style.display = 'none';
                resultsContainer.style.display = 'none';

                try {
                    // First, save the current config
                    await saveConfig();

                    const response = await fetch('/api/backtest/run', { method: 'POST' });
                    if (response.status === 202) {
                        const data = await response.json();
                        currentRunId = data.run_id;
                        updateStatus(`Backtest started with Run ID: ${currentRunId}`);
                        document.getElementById('run-id-display').textContent = currentRunId;
                    } else {
                        const error = await response.json();
                        throw new Error(error.error || 'Failed to start backtest');
                    }
                } catch (e) {
                    console.error("Failed to run backtest", e);
                    alert(`Failed to run backtest: ${e.message}`);
                    runBtn.disabled = false;
                    progressContainer.style.display = 'none';
                }
            }

            // --- Event Listeners ---
            runBtn.addEventListener('click', runBacktest);
            saveBtn.addEventListener('click', saveConfig);

            // --- Initial Load ---
            loadConfig();
            setupWebSocket();
        });
    </script>
</body>
</html>